package ai.pentest;

import burp.*;

import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.function.BiConsumer;

/**
 * Conservative, safe active checks. Only low-risk, idempotent-style checks with explicit consent.
 * Examples:
 * - Header probing (e.g., security headers)
 * - OPTIONS method discovery (non-destructive)
 * - Authentication schema checks (no brute-force)
 */
public class ActiveChecks {

    private final IBurpExtenderCallbacks callbacks;
    private final IExtensionHelpers helpers;
    private final AuditLogger auditLogger;
    private final BiConsumer<IHttpRequestResponse, Issue.TentativeAssessment> issueReporter;
    private volatile boolean activeChecksEnabled = false;

    public ActiveChecks(IBurpExtenderCallbacks callbacks, AuditLogger auditLogger,
                        BiConsumer<IHttpRequestResponse, Issue.TentativeAssessment> issueReporter) {
        this.callbacks = callbacks;
        this.helpers = callbacks.getHelpers();
        this.auditLogger = auditLogger;
        this.issueReporter = issueReporter;
    }

    public void setActiveChecksEnabled(boolean enabled) {
        this.activeChecksEnabled = enabled;
    }

    public boolean isActiveChecksEnabled() {
        return activeChecksEnabled;
    }

    public void runConservativeChecks(IHttpRequestResponse baseRequest) {
        if (!activeChecksEnabled) return;
        IRequestInfo info = helpers.analyzeRequest(baseRequest);
        URL url = info.getUrl();

        // 1) OPTIONS probe
        byte[] optionsReq = buildSimpleRequest(url, "OPTIONS");
        IHttpRequestResponse optionsResp = callbacks.makeHttpRequest(baseRequest.getHttpService(), optionsReq);
        auditLogger.logEvent("active_options", url.getPath(), "", safeRespMeta(optionsResp));

        // 2) HEAD probe
        byte[] headReq = buildSimpleRequest(url, "HEAD");
        IHttpRequestResponse headResp = callbacks.makeHttpRequest(baseRequest.getHttpService(), headReq);
        auditLogger.logEvent("active_head", url.getPath(), "", safeRespMeta(headResp));

        List<String> notes = new ArrayList<>();
        if (!hasHeader(optionsResp, "allow") && status(optionsResp) == 200) {
            notes.add("OPTIONS 200 but missing Allow header");
        }
        if (!hasSecurityHeaders(headResp)) {
            notes.add("Missing recommended security headers");
        }

        if (!notes.isEmpty()) {
            Issue.TentativeAssessment assessment = new Issue.TentativeAssessment(
                    "Potential hardening gaps",
                    String.join("; ", notes),
                    "Review headers and methods; verify manually",
                    "API9:2023 - Improper Inventory/Hardening"
            );
            if (issueReporter != null) {
                issueReporter.accept(baseRequest, assessment);
            }
        }
    }

    private byte[] buildSimpleRequest(URL url, String method) {
        String path = url.getPath() + (url.getQuery() == null ? "" : ("?" + url.getQuery()));
        List<String> headers = new ArrayList<>();
        headers.add(method + " " + path + " HTTP/1.1");
        headers.add("Host: " + url.getHost());
        headers.add("User-Agent: Burp AI Pentest");
        headers.add("Accept: */*");
        return helpers.buildHttpMessage(headers, new byte[0]);
    }

    private boolean hasHeader(IHttpRequestResponse resp, String nameLower) {
        IResponseInfo r = helpers.analyzeResponse(resp.getResponse());
        for (String h : r.getHeaders()) {
            String lower = h.toLowerCase();
            if (lower.startsWith(nameLower.toLowerCase() + ":")) return true;
        }
        return false;
    }

    private boolean hasSecurityHeaders(IHttpRequestResponse resp) {
        IResponseInfo r = helpers.analyzeResponse(resp.getResponse());
        boolean csp = false, xcto = false, xfo = false;
        for (String h : r.getHeaders()) {
            String l = h.toLowerCase();
            if (l.startsWith("content-security-policy:")) csp = true;
            if (l.startsWith("x-content-type-options:")) xcto = true;
            if (l.startsWith("x-frame-options:")) xfo = true;
        }
        return csp || xcto || xfo; // at least one present
    }

    private String safeRespMeta(IHttpRequestResponse resp) {
        try {
            IResponseInfo r = helpers.analyzeResponse(resp.getResponse());
            return "status=" + r.getStatusCode() + "; hdrs=" + r.getHeaders().size();
        } catch (Exception e) {
            return "n/a";
        }
    }

    private int status(IHttpRequestResponse resp) {
        try {
            IResponseInfo r = helpers.analyzeResponse(resp.getResponse());
            return r.getStatusCode();
        } catch (Exception e) {
            return -1;
        }
    }
}


