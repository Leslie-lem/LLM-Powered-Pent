package ai.pentest.ui;

import javax.swing.*;
import javax.swing.text.BadLocationException;
import javax.swing.text.Style;
import javax.swing.text.StyleConstants;
import javax.swing.text.StyledDocument;
import java.awt.*;

/**
 * Styled console dedicated to LLM feedback and pipeline events.
 * Supports color-coded log categories (queued, batch, llm, error, realtime).
 */
public class LLMLivePanel extends JPanel {

    private final JTextPane textPane;
    private final StyledDocument document;

    public LLMLivePanel() {
        super(new BorderLayout());

        textPane = new JTextPane();
        textPane.setEditable(false);
        textPane.setBackground(UITheme.BACKGROUND_CARD);
        textPane.setForeground(UITheme.TEXT_PRIMARY);
        textPane.setFont(UITheme.FONT_MONO);
        textPane.setOpaque(true);  // Explicitly make it opaque
        textPane.setVisible(true);  // Explicitly make it visible

        document = textPane.getStyledDocument();
        initStyles();

        JScrollPane scrollPane = StyledComponents.createStyledScrollPane(textPane);
        scrollPane.setBorder(BorderFactory.createEmptyBorder());
        add(scrollPane, BorderLayout.CENTER);
        
        // Add a test message to verify the panel is working
        append("LLM Feedback Stream initialized. Waiting for events...", "info");
    }

    private void initStyles() {
        addStyle("queued", UITheme.ACCENT_SECONDARY);
        addStyle("batch", UITheme.ACCENT_WARNING);
        addStyle("llm", UITheme.ACCENT_PRIMARY);
        addStyle("error", UITheme.ACCENT_DANGER);
        addStyle("realtime", UITheme.ACCENT_SUCCESS);
        addStyle("info", UITheme.TEXT_PRIMARY);
    }

    private void addStyle(String name, Color color) {
        Style style = textPane.addStyle(name, null);
        StyleConstants.setForeground(style, color);
        StyleConstants.setFontFamily(style, UITheme.FONT_MONO.getFamily());
        StyleConstants.setFontSize(style, UITheme.FONT_MONO.getSize());
    }

    /**
     * Append a line of text to the console using the specified style.
     */
    public void append(String text, String styleName) {
        // Ensure we're on EDT
        if (!SwingUtilities.isEventDispatchThread()) {
            SwingUtilities.invokeLater(() -> append(text, styleName));
            return;
        }
        
        Style style = textPane.getStyle(styleName != null ? styleName : "info");
        if (style == null) {
            style = textPane.getStyle("info");
        }
        try {
            document.insertString(document.getLength(), text + "\n", style);
            textPane.setCaretPosition(document.getLength());
            textPane.repaint();
            // Force scroll to bottom
            JScrollPane scrollPane = (JScrollPane) SwingUtilities.getAncestorOfClass(JScrollPane.class, textPane);
            if (scrollPane != null) {
                JScrollBar vertical = scrollPane.getVerticalScrollBar();
                vertical.setValue(vertical.getMaximum());
            }
        } catch (BadLocationException e) {
            System.err.println("LLMLivePanel append error: " + e.getMessage());
            try {
                document.insertString(document.getLength(), "[Log Error] " + e.getMessage() + "\n",
                        textPane.getStyle("error"));
            } catch (BadLocationException ignored) {
                // Give up, nothing else we can do.
            }
        }
    }
}
