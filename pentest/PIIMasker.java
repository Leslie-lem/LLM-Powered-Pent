package ai.pentest;

import java.util.regex.Pattern;

public class PIIMasker {
    // Simple regex-based masker; extend for org-specific policies
    private final Pattern email = Pattern.compile("[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}");
    private final Pattern bearer = Pattern.compile("(?i)authorization: *bearer +[A-Za-z0-9._-]+");
    // JWT partials: header + (optional) payload + (optional) signature
    private final Pattern jwt = Pattern.compile("eyJ[A-Za-z0-9_-]+(\\.[A-Za-z0-9_-]+)?(\\.[A-Za-z0-9_-]+)?");
    private final Pattern uuid = Pattern.compile("[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}");
    private final Pattern creditCard = Pattern.compile("\\b(?:\\d[ -]*?){13,19}\\b");
    private final Pattern phone = Pattern.compile("(?:(?:\\+?1)[-._\\s]?)?(?:\\(?[0-9]{3}\\)?)[-._\\s]?[0-9]{3}[-._\\s]?[0-9]{4}");

    public String mask(String input) { return maskWithPath(input, null); }

    public String maskWithPath(String input, String urlPath) {
        if (input == null) return null;
        String s = input;
        s = email.matcher(s).replaceAll("<email>");
        s = bearer.matcher(s).replaceAll("Authorization: Bearer <token>");
        s = jwt.matcher(s).replaceAll("<jwt>");
        s = phone.matcher(s).replaceAll("<phone>");
        // path-aware UUID/CC masking: don't mask if the exact match appears in the URL path
        s = replaceUnlessInPath(s, uuid, "<uuid>", urlPath);
        s = replaceUnlessInPath(s, creditCard, "<card>", urlPath);
        return s;
    }

    private String replaceUnlessInPath(String text, Pattern pattern, String replacement, String urlPath) {
        if (text == null) return null;
        if (urlPath == null || urlPath.isEmpty()) return pattern.matcher(text).replaceAll(replacement);
        java.util.regex.Matcher m = pattern.matcher(text);
        StringBuffer sb = new StringBuffer();
        while (m.find()) {
            String match = m.group();
            if (urlPath.contains(match)) {
                m.appendReplacement(sb, java.util.regex.Matcher.quoteReplacement(match));
            } else {
                m.appendReplacement(sb, java.util.regex.Matcher.quoteReplacement(replacement));
            }
        }
        m.appendTail(sb);
        return sb.toString();
    }
}


