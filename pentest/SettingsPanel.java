package ai.pentest;

import burp.ITab;
import ai.pentest.ui.*;

import javax.swing.*;
import java.awt.*;
import java.util.Arrays;
import java.util.concurrent.CompletableFuture;
import java.util.function.Consumer;
import java.util.function.Supplier;

/**
 * Modern, professional settings panel with cybersecurity theme.
 * Features a tech background, styled components, and intuitive layout.
 */
public class SettingsPanel extends JPanel implements ITab {

    private final JPasswordField apiKeyField;
    private final JLabel apiStatusLabel;
    private final JComboBox<String> modelBox;
    private final JCheckBox enableActiveChecks;
    private final JSpinner thresholdSpinner;
    private final JTextArea guidance;
    private final TechBackgroundPanel backgroundPanel;
    private final LLMLivePanel livePanel;
    private final JButton pingButton;

    private final Consumer<String> onApiKeyChange;
    private final Consumer<Boolean> onActiveToggle;
    private final Consumer<String> onModelChange;
    private final Consumer<Double> onThresholdChange;
    private final java.util.function.BiConsumer<String,String> onPersist;
    private final Supplier<CompletableFuture<String>> onPing;

    private boolean hasSavedApiKey = false;
    private String lastSavedApiKey = "";

    public SettingsPanel(Consumer<String> onApiKeyChange, Consumer<Boolean> onActiveToggle,
                         Consumer<String> onModelChange, java.util.function.BiConsumer<String,String> onPersist,
                         Consumer<Double> onThresholdChange,
                         Supplier<CompletableFuture<String>> onPing) {
        super(new BorderLayout());
        this.onApiKeyChange = onApiKeyChange;
        this.onActiveToggle = onActiveToggle;
        this.onModelChange = onModelChange == null ? m -> {} : onModelChange;
        this.onPersist = onPersist == null ? (a,b) -> {} : onPersist;
        this.onThresholdChange = onThresholdChange == null ? t -> {} : onThresholdChange;
        this.onPing = onPing == null ? () -> {
            CompletableFuture<String> f = new CompletableFuture<>();
            f.completeExceptionally(new IllegalStateException("Ping not available"));
            return f;
        } : onPing;

        // Set background
        setBackground(UITheme.BACKGROUND_PRIMARY);
        
        // Create layered pane for background effect
        JLayeredPane layeredPane = new JLayeredPane();
        layeredPane.setLayout(new BorderLayout());
        
        // Tech background
        backgroundPanel = new TechBackgroundPanel();
        backgroundPanel.setLayout(new BorderLayout());
        
        // Initialize components first
        apiKeyField = new JPasswordField(35);
        apiKeyField.setFont(UITheme.FONT_BODY);
        apiKeyField.setForeground(UITheme.TEXT_PRIMARY);
        apiKeyField.setBackground(UITheme.BACKGROUND_CARD);
        apiKeyField.setBorder(StyledComponents.createInputBorder());
        apiKeyField.setCaretColor(UITheme.ACCENT_PRIMARY);
        apiKeyField.setEchoChar('*');
        modelBox = StyledComponents.createStyledComboBox(new String[]{"gpt-4o-mini", "gpt-40-mini"});
        enableActiveChecks = StyledComponents.createStyledCheckBox("Enable safe active checks (manual confirmation required)");
        thresholdSpinner = StyledComponents.createStyledSpinner(new SpinnerNumberModel(0.6, 0.0, 1.0, 0.1));
        guidance = StyledComponents.createStyledTextArea();
        livePanel = new LLMLivePanel();
        apiStatusLabel = StyledComponents.createBodyLabel("No API key saved");
        apiStatusLabel.setForeground(UITheme.TEXT_MUTED);
        pingButton = StyledComponents.createPrimaryButton("Ping LLM");
        pingButton.addActionListener(e -> handlePing());
        
        // Main content panel (opaque with slight transparency effect)
        JPanel contentPanel = new JPanel(new BorderLayout());
        contentPanel.setOpaque(false);
        contentPanel.setBorder(BorderFactory.createEmptyBorder(UITheme.PADDING_LARGE, 
                                                               UITheme.PADDING_LARGE, 
                                                               UITheme.PADDING_LARGE, 
                                                               UITheme.PADDING_LARGE));
        
        // Header section
        JPanel headerPanel = createHeaderPanel();
        contentPanel.add(headerPanel, BorderLayout.NORTH);
        
        // Main form section
        JPanel formPanel = createFormPanel();
        contentPanel.add(formPanel, BorderLayout.CENTER);
        
        // Guidance section
        JPanel guidancePanel = createGuidancePanel();
        contentPanel.add(guidancePanel, BorderLayout.SOUTH);
        
        // Live feedback panel container
        JPanel livePanelCard = StyledComponents.createCardPanel();
        livePanelCard.setLayout(new BorderLayout());
        livePanelCard.setBorder(BorderFactory.createCompoundBorder(
            livePanelCard.getBorder(),
            BorderFactory.createEmptyBorder(UITheme.PADDING_MEDIUM, UITheme.PADDING_MEDIUM, 
                                          UITheme.PADDING_MEDIUM, UITheme.PADDING_MEDIUM)
        ));
        JLabel livePanelTitle = StyledComponents.createSubheadingLabel("LLM Feedback Stream");
        livePanelTitle.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_MEDIUM, 0));
        livePanelCard.add(livePanelTitle, BorderLayout.NORTH);
        livePanelCard.add(livePanel, BorderLayout.CENTER);
        
        JPanel overlayPanel = new JPanel(new BorderLayout());
        overlayPanel.setOpaque(false);
        overlayPanel.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_LARGE, 0));
        overlayPanel.add(contentPanel, BorderLayout.NORTH);
        overlayPanel.add(livePanelCard, BorderLayout.CENTER);
        
        backgroundPanel.add(overlayPanel, BorderLayout.CENTER);
        
        // Add components to layered pane
        layeredPane.add(backgroundPanel, BorderLayout.CENTER);
        
        add(layeredPane, BorderLayout.CENTER);
        
        setupEventHandlers();
        updateApiStatusLabel();
    }
    
    private JPanel createHeaderPanel() {
        JPanel header = new JPanel(new BorderLayout());
        header.setOpaque(false);
        header.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_LARGE, 0));
        
        JLabel title = StyledComponents.createHeadingLabel("AI Pentest Assistant");
        JLabel subtitle = StyledComponents.createSubheadingLabel("Advanced LLM-Powered Security Analysis");
        
        JPanel titlePanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 5));
        titlePanel.setOpaque(false);
        titlePanel.add(title);
        
        JPanel subtitlePanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 0));
        subtitlePanel.setOpaque(false);
        subtitlePanel.add(subtitle);
        
        header.add(titlePanel, BorderLayout.NORTH);
        header.add(subtitlePanel, BorderLayout.CENTER);
        
        return header;
    }
    
    private JPanel createFormPanel() {
        JPanel form = StyledComponents.createCardPanel();
        form.setLayout(new BoxLayout(form, BoxLayout.Y_AXIS));
        form.setBorder(BorderFactory.createCompoundBorder(
            form.getBorder(),
            BorderFactory.createEmptyBorder(UITheme.PADDING_LARGE, UITheme.PADDING_LARGE, 
                                          UITheme.PADDING_LARGE, UITheme.PADDING_LARGE)
        ));
        
        // API Configuration Section
        JLabel apiSectionLabel = StyledComponents.createSubheadingLabel("LLM Configuration");
        apiSectionLabel.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_MEDIUM, 0));
        form.add(apiSectionLabel);
        form.add(Box.createVerticalStrut(UITheme.PADDING_SMALL));
        
        JPanel apiRow = new JPanel(new FlowLayout(FlowLayout.LEFT, UITheme.PADDING_MEDIUM, UITheme.PADDING_SMALL));
        apiRow.setOpaque(false);
        apiRow.add(StyledComponents.createBodyLabel("API Key:"));
        apiRow.add(apiKeyField);
        apiRow.add(Box.createHorizontalStrut(UITheme.PADDING_SMALL));
        apiRow.add(apiStatusLabel);
        apiRow.add(Box.createHorizontalStrut(UITheme.PADDING_MEDIUM));
        apiRow.add(StyledComponents.createBodyLabel("Model:"));
        apiRow.add(modelBox);
        form.add(apiRow);
        form.add(Box.createVerticalStrut(UITheme.PADDING_MEDIUM));
        
        // Threshold Configuration
        JLabel thresholdSectionLabel = StyledComponents.createSubheadingLabel("Analysis Settings");
        thresholdSectionLabel.setBorder(BorderFactory.createEmptyBorder(UITheme.PADDING_MEDIUM, 0, 
                                                                        UITheme.PADDING_MEDIUM, 0));
        form.add(thresholdSectionLabel);
        form.add(Box.createVerticalStrut(UITheme.PADDING_SMALL));
        
        JPanel thresholdRow = new JPanel(new FlowLayout(FlowLayout.LEFT, UITheme.PADDING_MEDIUM, UITheme.PADDING_SMALL));
        thresholdRow.setOpaque(false);
        thresholdRow.add(StyledComponents.createBodyLabel("Scoring Threshold:"));
        thresholdRow.add(thresholdSpinner);
        thresholdRow.add(Box.createHorizontalStrut(UITheme.PADDING_SMALL));
        JLabel thresholdHint = StyledComponents.createBodyLabel("(0.0-1.0, default: 0.6)");
        thresholdHint.setForeground(UITheme.TEXT_MUTED);
        thresholdRow.add(thresholdHint);
        form.add(thresholdRow);
        form.add(Box.createVerticalStrut(UITheme.PADDING_MEDIUM));
        
        // Active Checks Toggle
        form.add(enableActiveChecks);
        form.add(Box.createVerticalStrut(UITheme.PADDING_MEDIUM));
        
        // Save Button
        JButton saveButton = StyledComponents.createPrimaryButton("Save Configuration");
        saveButton.addActionListener(e -> handleSave());
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        buttonPanel.setOpaque(false);
        buttonPanel.add(saveButton);
        pingButton.setPreferredSize(new Dimension(120, 35));
        buttonPanel.add(Box.createHorizontalStrut(UITheme.PADDING_SMALL));
        buttonPanel.add(pingButton);
        form.add(buttonPanel);
        
        return form;
    }
    
    private JPanel createGuidancePanel() {
        JPanel guidancePanel = StyledComponents.createCardPanel();
        guidancePanel.setLayout(new BorderLayout());
        guidancePanel.setBorder(BorderFactory.createCompoundBorder(
            guidancePanel.getBorder(),
            BorderFactory.createEmptyBorder(UITheme.PADDING_MEDIUM, UITheme.PADDING_MEDIUM, 
                                          UITheme.PADDING_MEDIUM, UITheme.PADDING_MEDIUM)
        ));
        
        JLabel guidanceTitle = StyledComponents.createSubheadingLabel("Safety & Operational Guidance");
        guidanceTitle.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_MEDIUM, 0));
        guidancePanel.add(guidanceTitle, BorderLayout.NORTH);
        
        guidance.setText(
            "Passive Analysis by Default\n" +
            "   All analysis is passive and safe. No requests are modified or sent without explicit confirmation.\n\n" +
            "Authorized Testing Only\n" +
            "   Only test targets you are authorized to assess. Ensure proper authorization before use.\n\n" +
            "PII Protection\n" +
            "   The tool automatically masks common PII patterns in prompts. Sensitive data is protected.\n\n" +
            "Active Checks Require Confirmation\n" +
            "   Active security checks are conservative and require manual confirmation before execution.\n\n" +
            "Tentative Findings\n" +
            "   All findings are tentative and should be verified manually. Use as a guide, not absolute truth."
        );
        
        JScrollPane scrollPane = StyledComponents.createStyledScrollPane(guidance);
        scrollPane.setPreferredSize(new Dimension(0, 200));
        guidancePanel.add(scrollPane, BorderLayout.CENTER);
        
        return guidancePanel;
    }
    
    private void setupEventHandlers() {
        modelBox.addActionListener(e -> {
            String model = (String) modelBox.getSelectedItem();
            onModelChange.accept(model);
        });
        
        thresholdSpinner.addChangeListener(e -> {
            double threshold = ((Number) thresholdSpinner.getValue()).doubleValue();
            onThresholdChange.accept(threshold);
        });
        
        enableActiveChecks.addActionListener(e -> 
            onActiveToggle.accept(enableActiveChecks.isSelected())
        );
    }
    
    private void handleSave() {
        char[] keyChars = apiKeyField.getPassword();
        String enteredKey = new String(keyChars).trim();
        Arrays.fill(keyChars, '\0');
        String model = (String) modelBox.getSelectedItem();
        onModelChange.accept(model);
        double threshold = ((Number) thresholdSpinner.getValue()).doubleValue();
        onThresholdChange.accept(threshold);
        String keyToPersist = lastSavedApiKey;
        boolean keyChanged = false;

        if (!enteredKey.isEmpty()) {
            keyToPersist = enteredKey;
            lastSavedApiKey = enteredKey;
            hasSavedApiKey = true;
            onApiKeyChange.accept(enteredKey);
            apiKeyField.setText("");
            keyChanged = true;
            livePanel.append("API key saved. LLM requests will use the stored key.", "info");
        } else if (!hasSavedApiKey) {
            keyToPersist = "";
            lastSavedApiKey = "";
            onApiKeyChange.accept("");
            livePanel.append("API key cleared.", "info");
        }

        onPersist.accept(keyToPersist, model);
        updateApiStatusLabel();
        
        JOptionPane.showMessageDialog(
            this,
            keyChanged ? "Configuration saved and API key updated." : "Configuration saved successfully!",
            "Settings Saved",
            JOptionPane.INFORMATION_MESSAGE
        );
    }

    private void handlePing() {
        if (!hasSavedApiKey) {
            livePanel.append("Ping aborted: no API key saved.", "error");
            return;
        }

        pingButton.setEnabled(false);
        livePanel.append("Ping: contacting LLM...", "info");
        try {
            CompletableFuture<String> future = onPing.get();
            if (future == null) {
                pingButton.setEnabled(true);
                livePanel.append("Ping unavailable: no handler provided.", "error");
                return;
            }
            future.whenComplete((response, throwable) -> SwingUtilities.invokeLater(() -> {
                pingButton.setEnabled(true);
                if (throwable != null) {
                    String errorMsg = "Ping failed: " + throwable.getMessage();
                    livePanel.append(errorMsg, "error");
                    System.out.println("AI Pentest [Ping Error]: " + errorMsg);
                    // Fallback: Show popup
                    JOptionPane.showMessageDialog(SettingsPanel.this, 
                        "Ping Failed:\n" + errorMsg, 
                        "LLM Connection Test", 
                        JOptionPane.ERROR_MESSAGE);
                } else if (response == null || response.trim().isEmpty()) {
                    livePanel.append("Ping completed with empty response.", "info");
                    System.out.println("AI Pentest [Ping]: Empty response");
                    JOptionPane.showMessageDialog(SettingsPanel.this, 
                        "Ping completed but received empty response.", 
                        "LLM Connection Test", 
                        JOptionPane.WARNING_MESSAGE);
                } else {
                    String responseMsg = "Ping response: " + response.trim();
                    livePanel.append(responseMsg, "llm");
                    System.out.println("AI Pentest [Ping Success]: " + responseMsg);
                    // Fallback: Show popup with response
                    JOptionPane.showMessageDialog(SettingsPanel.this, 
                        "LLM Connection Successful!\n\nResponse: " + response.trim(), 
                        "LLM Connection Test", 
                        JOptionPane.INFORMATION_MESSAGE);
                }
            }));
        } catch (Exception ex) {
            pingButton.setEnabled(true);
            livePanel.append("Ping failed: " + ex.getMessage(), "error");
        }
    }

    private void updateApiStatusLabel() {
        if (hasSavedApiKey) {
            apiStatusLabel.setText("Saved API key");
            apiStatusLabel.setForeground(UITheme.ACCENT_SUCCESS);
        } else {
            apiStatusLabel.setText("No API key saved");
            apiStatusLabel.setForeground(UITheme.TEXT_MUTED);
        }
        pingButton.setEnabled(hasSavedApiKey);
    }

    public void setSavedApiKey(String savedKey) {
        if (savedKey != null && !savedKey.trim().isEmpty()) {
            hasSavedApiKey = true;
            lastSavedApiKey = savedKey.trim();
        } else {
            hasSavedApiKey = false;
            lastSavedApiKey = "";
        }
        apiKeyField.setText("");
        updateApiStatusLabel();
    }

    public LLMLivePanel getLivePanel() {
        return livePanel;
    }

    @Override
    public String getTabCaption() {
        return "AI Pentest";
    }

    @Override
    public Component getUiComponent() {
        return this;
    }
}
