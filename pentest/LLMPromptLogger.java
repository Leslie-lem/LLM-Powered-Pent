package ai.pentest;

import burp.IBurpExtenderCallbacks;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * Logger that captures every prompt sent to the LLM so we can demonstrate the evidence that was shared.
 */
public class LLMPromptLogger {

    private final IBurpExtenderCallbacks callbacks;
    private final SimpleDateFormat fmt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    private final ExecutorService executor = Executors.newSingleThreadExecutor(r -> {
        Thread t = new Thread(r, "ai-llm-prompt-logger");
        t.setDaemon(true);
        return t;
    });
    private final File outFile;
    private boolean fileInitialized = false;

    public LLMPromptLogger(IBurpExtenderCallbacks callbacks) {
        this.callbacks = callbacks;
        File dir = new File(System.getProperty("user.home"), ".burp-ai-audit");
        if (!dir.exists()) dir.mkdirs();
        this.outFile = new File(dir, "llm-prompts.md");
    }

    public void logPrompt(String context, String method, String path, String promptBody) {
        if (promptBody == null || promptBody.trim().isEmpty()) {
            return;
        }

        String timestamp = fmt.format(new Date());
        StringBuilder markdown = new StringBuilder();
        markdown.append("\n\n---\n\n");
        markdown.append("### ").append(timestamp).append(" - ").append(context).append("\n");
        markdown.append("**Endpoint:** ").append(method == null ? "" : method).append(" ").append(path == null ? "" : path).append("\n\n");
        markdown.append("```\n").append(promptBody).append("\n```\n");

        executor.submit(() -> appendToFile(markdown.toString()));
    }

    private void ensureFileInitialized() {
        if (fileInitialized) return;

        if (!outFile.exists() || outFile.length() == 0) {
            String header = "# AI Pentest Assistant - LLM Prompt Log\n\n" +
                    "This file captures every prompt (with masking applied) that was sent to the LLM so reviewers can " +
                    "see the exact summaries and evidence provided for each endpoint.\n\n" +
                    "**Generated:** " + fmt.format(new Date()) + "\n\n" +
                    "---\n\n";
            try (BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(
                    new FileOutputStream(outFile, false), StandardCharsets.UTF_8))) {
                bw.write(header);
            } catch (IOException e) {
                callbacks.printError("LLMPromptLogger: Failed to initialize file - " + e.getMessage());
            }
        }
        fileInitialized = true;
    }

    private void appendToFile(String content) {
        ensureFileInitialized();

        try (BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(
                new FileOutputStream(outFile, true), StandardCharsets.UTF_8))) {
            bw.write(content);
            bw.flush();
        } catch (IOException e) {
            callbacks.printError("LLMPromptLogger: Failed to write to file - " + e.getMessage());
        }
    }

    public void shutdown() {
        executor.shutdown();
    }
}

