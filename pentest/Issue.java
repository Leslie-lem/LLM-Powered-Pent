package ai.pentest;

import burp.*;

import java.net.URL;

public class Issue {

    public static class TentativeAssessment {
        public final String title;
        public final String evidence;
        public final String remediation;
        public final String owaspCategory;

        public TentativeAssessment(String title, String evidence, String remediation, String owaspCategory) {
            this.title = title;
            this.evidence = evidence;
            this.remediation = remediation;
            this.owaspCategory = owaspCategory;
        }
    }

    public static TentativeAssessment evaluateTentative(String llmResponse, PromptBuilder.PTTNode node) {
        if (llmResponse == null) return null;
        String lower = llmResponse.toLowerCase();
        // Very conservative trigger words
        if (lower.contains("high confidence") || lower.contains("likely vulnerable") || lower.contains("probable")) {
            return new TentativeAssessment(
                    "Tentative finding at " + node.method + " " + node.urlPath,
                    truncate(llmResponse, 400),
                    "Verify manually. Reproduce with minimal input; avoid destructive actions.",
                    "OWASP API Top 10 (2023)"
            );
        }
        return null;
    }

    public static IScanIssue buildTentativeIssue(IBurpExtenderCallbacks callbacks, IHttpRequestResponse base, TentativeAssessment a) {
        IExtensionHelpers helpers = callbacks.getHelpers();
        IRequestInfo req = helpers.analyzeRequest(base);
        URL url = req.getUrl();

        return new IScanIssue() {
            @Override public URL getUrl() { return url; }
            @Override public String getIssueName() { return a.title; }
            @Override public int getIssueType() { return 0; }
            @Override public String getSeverity() { return "Information"; }
            @Override public String getConfidence() { return "Tentative"; }
            @Override public String getIssueBackground() { return "This issue was suggested by an AI assistant based on passive heuristics."; }
            @Override public String getRemediationBackground() { return "Manual verification is required. Only perform authorized testing."; }
            @Override public String getIssueDetail() { return escapeHtml(a.evidence) + "<br/><br/>Category: " + a.owaspCategory; }
            @Override public String getRemediationDetail() { return escapeHtml(a.remediation); }
            @Override public IHttpRequestResponse[] getHttpMessages() { return new IHttpRequestResponse[] { base }; }
            @Override public IHttpService getHttpService() { return base.getHttpService(); }
        };
    }

    private static String truncate(String s, int max) {
        if (s == null) return null;
        return s.length() > max ? s.substring(0, max) + "..." : s;
    }

    private static String escapeHtml(String s) {
        if (s == null) return "";
        return s.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;");
    }
}


