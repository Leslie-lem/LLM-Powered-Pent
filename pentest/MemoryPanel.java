package ai.pentest;

import burp.ITab;
import ai.pentest.ui.*;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.time.Instant;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.List;

/**
 * Modern memory management panel with professional styling and visual feedback.
 * Displays session statistics and provides history clearing functionality.
 */
public class MemoryPanel extends JPanel implements ITab {
    
    private final MemoryManager memoryManager;
    private final JLabel statsLabel;
    private final JButton clearButton;
    private final JTextArea infoArea;
    private final TechBackgroundPanel backgroundPanel;
    private final DefaultListModel<MemoryManager.FindingRecord> findingsModel;
    private final JList<MemoryManager.FindingRecord> findingsList;
    private final DateTimeFormatter timeFormatter = DateTimeFormatter.ofPattern("HH:mm:ss")
            .withZone(ZoneId.systemDefault());
    
    public MemoryPanel(MemoryManager memoryManager) {
        super(new BorderLayout());
        this.memoryManager = memoryManager;
        
        // Set background
        setBackground(UITheme.BACKGROUND_PRIMARY);
        
        // Create layered pane for background effect
        JLayeredPane layeredPane = new JLayeredPane();
        layeredPane.setLayout(new BorderLayout());
        
        // Tech background
        backgroundPanel = new TechBackgroundPanel();
        backgroundPanel.setLayout(new BorderLayout());
        
        // Main content panel
        JPanel contentPanel = new JPanel(new BorderLayout());
        contentPanel.setOpaque(false);
        contentPanel.setBorder(BorderFactory.createEmptyBorder(UITheme.PADDING_LARGE, 
                                                               UITheme.PADDING_LARGE, 
                                                               UITheme.PADDING_LARGE, 
                                                               UITheme.PADDING_LARGE));
        
        // Header
        JPanel headerPanel = createHeaderPanel();
        contentPanel.add(headerPanel, BorderLayout.NORTH);
        
        findingsModel = new DefaultListModel<>();
        findingsList = new JList<>(findingsModel);
        findingsList.setOpaque(false);
        findingsList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        findingsList.setCellRenderer(new FindingsCellRenderer());
        findingsList.setBorder(new EmptyBorder(0, 0, 0, 0));

        // Initialize components
        statsLabel = new JLabel("Loading statistics...");
        clearButton = StyledComponents.createDangerButton("Clear All History");
        infoArea = StyledComponents.createStyledTextArea();
        
        // Stats and controls
        JPanel statsPanel = createStatsPanel();
        JPanel findingsPanel = createFindingsPanel();

        JPanel centerPanel = new JPanel();
        centerPanel.setOpaque(false);
        centerPanel.setLayout(new BoxLayout(centerPanel, BoxLayout.Y_AXIS));
        centerPanel.add(statsPanel);
        centerPanel.add(Box.createVerticalStrut(UITheme.PADDING_MEDIUM));
        centerPanel.add(findingsPanel);
        
        contentPanel.add(centerPanel, BorderLayout.CENTER);
        
        // Info section
        JPanel infoPanel = createInfoPanel();
        contentPanel.add(infoPanel, BorderLayout.SOUTH);
        
        // Add to layered pane
        layeredPane.add(backgroundPanel, BorderLayout.CENTER, 0);
        layeredPane.add(contentPanel, BorderLayout.CENTER, 1);
        
        add(layeredPane, BorderLayout.CENTER);
        
        setupComponents();
        updateStats();
        refreshFindings();
        
        // Auto-refresh stats every 5 seconds
        Timer timer = new Timer(5000, e -> {
            updateStats();
            refreshFindings();
        });
        timer.start();
    }
    
    private JPanel createHeaderPanel() {
        JPanel header = new JPanel(new BorderLayout());
        header.setOpaque(false);
        header.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_LARGE, 0));
        
        JLabel title = StyledComponents.createHeadingLabel("Memory Management");
        JLabel subtitle = StyledComponents.createSubheadingLabel("Session Statistics & History Control");
        
        JPanel titlePanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 5));
        titlePanel.setOpaque(false);
        titlePanel.add(title);
        
        JPanel subtitlePanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 0));
        subtitlePanel.setOpaque(false);
        subtitlePanel.add(subtitle);
        
        header.add(titlePanel, BorderLayout.NORTH);
        header.add(subtitlePanel, BorderLayout.CENTER);
        
        return header;
    }
    
    private JPanel createStatsPanel() {
        JPanel statsCard = StyledComponents.createCardPanel();
        statsCard.setLayout(new BorderLayout());
        statsCard.setBorder(BorderFactory.createCompoundBorder(
            statsCard.getBorder(),
            BorderFactory.createEmptyBorder(UITheme.PADDING_LARGE, UITheme.PADDING_LARGE, 
                                          UITheme.PADDING_LARGE, UITheme.PADDING_LARGE)
        ));
        
        JLabel statsTitle = StyledComponents.createSubheadingLabel("Current Session Statistics");
        statsTitle.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_MEDIUM, 0));
        statsCard.add(statsTitle, BorderLayout.NORTH);
        
        // Stats display
        statsLabel.setFont(UITheme.FONT_BODY);
        statsLabel.setForeground(UITheme.TEXT_PRIMARY);
        statsLabel.setBorder(BorderFactory.createEmptyBorder(UITheme.PADDING_MEDIUM, 0, 
                                                             UITheme.PADDING_MEDIUM, 0));
        statsCard.add(statsLabel, BorderLayout.CENTER);
        
        // Clear button panel
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        buttonPanel.setOpaque(false);
        buttonPanel.setBorder(BorderFactory.createEmptyBorder(UITheme.PADDING_MEDIUM, 0, 0, 0));
        buttonPanel.add(clearButton);
        statsCard.add(buttonPanel, BorderLayout.SOUTH);
        
        return statsCard;
    }
    
    private JPanel createInfoPanel() {
        JPanel infoCard = StyledComponents.createCardPanel();
        infoCard.setLayout(new BorderLayout());
        infoCard.setBorder(BorderFactory.createCompoundBorder(
            infoCard.getBorder(),
            BorderFactory.createEmptyBorder(UITheme.PADDING_MEDIUM, UITheme.PADDING_MEDIUM, 
                                          UITheme.PADDING_MEDIUM, UITheme.PADDING_MEDIUM)
        ));
        
        JLabel infoTitle = StyledComponents.createSubheadingLabel("About Memory Management");
        infoTitle.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_MEDIUM, 0));
        infoCard.add(infoTitle, BorderLayout.NORTH);
        
        infoArea.setText(
            "Session Statistics\n" +
            "   Track processed endpoints, pending analysis, and cache utilization in real-time.\n\n" +
            "Clear All History\n" +
            "   Reset all extension data to start a fresh test session. This action clears:\n" +
            "   • Request Cache: Deduplication history of processed requests\n" +
            "   • PTT Cache: Cached vulnerability evaluation results\n" +
            "   • LLM Cache: Cached LLM responses (saves API costs on repeated queries)\n" +
            "   • Batch Queue: Pending endpoints waiting for batch analysis\n" +
            "   • Session Counters: Processed endpoint counts\n\n" +
            "Important Notes\n" +
            "   • Audit logs are written to file and cannot be cleared from here\n" +
            "   • Clearing history cannot be undone\n" +
            "   • For a completely fresh start, restart Burp Suite after clearing\n\n" +
            "Best Practice\n" +
            "   Clear history between different test targets to avoid cross-contamination of analysis."
        );
        
        JScrollPane scrollPane = StyledComponents.createStyledScrollPane(infoArea);
        scrollPane.setPreferredSize(new Dimension(0, 250));
        infoCard.add(scrollPane, BorderLayout.CENTER);
        
        return infoCard;
    }
    
    private void setupComponents() {
        clearButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                int confirm = JOptionPane.showConfirmDialog(
                    MemoryPanel.this,
                    "<html><body style='width: 400px;'>" +
                    "<b>Are you sure you want to clear ALL extension history?</b><br><br>" +
                    "This will permanently delete:<br>" +
                    "• Request cache (deduplication)<br>" +
                    "• PTT evaluation cache<br>" +
                    "• LLM response cache<br>" +
                    "• Batch processing queue<br>" +
                    "• Session counters<br><br>" +
                    "<b style='color: #FF5050;'>This action cannot be undone!</b>" +
                    "</body></html>",
                    "Clear All History - Confirm",
                    JOptionPane.YES_NO_OPTION,
                    JOptionPane.WARNING_MESSAGE
                );
                
                if (confirm == JOptionPane.YES_OPTION) {
                    memoryManager.clearAllHistory();
                    updateStats();
                    refreshFindings();
                    JOptionPane.showMessageDialog(
                        MemoryPanel.this,
                        "<html><body style='width: 300px;'>" +
                        "<b>All history cleared successfully!</b><br><br>" +
                        "You can now start a new test session.<br>" +
                        "For a completely fresh start, consider restarting Burp Suite." +
                        "</body></html>",
                        "History Cleared",
                        JOptionPane.INFORMATION_MESSAGE
                    );
                }
            }
        });
    }
    
    private void updateStats() {
        MemoryManager.MemoryStats stats = memoryManager.getStats();
        double cacheHitRate = stats.llmCacheSize > 0 && stats.processedEndpoints > 0
                ? (double) stats.llmCacheSize / (double) stats.processedEndpoints * 100.0
                : 0.0;
        statsLabel.setText(String.format(
            "<html><div style='line-height: 1.8;'>" +
            "<b style='color: %s;'>Session Statistics</b><br>" +
            "<span style='color: %s;'>Processed Endpoints:</span> " +
            "<span style='color: %s; font-weight: bold;'>%d</span><br>" +
            "<span style='color: %s;'>Pending Endpoints:</span> " +
            "<span style='color: %s; font-weight: bold;'>%d</span><br>" +
            "<span style='color: %s;'>LLM Cache Size:</span> " +
            "<span style='color: %s; font-weight: bold;'>%d responses</span><br>" +
            "<span style='color: %s;'>Tentative Findings:</span> " +
            "<span style='color: %s; font-weight: bold;'>%d</span><br>" +
            "<span style='color: %s;'>Cache Hit Rate:</span> " +
            "<span style='color: %s; font-weight: bold;'>%.1f%%</span>" +
            "</div></html>",
            toHex(UITheme.ACCENT_PRIMARY),
            toHex(UITheme.TEXT_SECONDARY),
            toHex(UITheme.ACCENT_PRIMARY),
            stats.processedEndpoints,
            toHex(UITheme.TEXT_SECONDARY),
            toHex(UITheme.ACCENT_WARNING),
            stats.pendingEndpoints,
            toHex(UITheme.TEXT_SECONDARY),
            toHex(UITheme.ACCENT_SECONDARY),
            stats.llmCacheSize,
            toHex(UITheme.TEXT_SECONDARY),
            toHex(UITheme.ACCENT_PRIMARY),
            stats.findingsCount,
            toHex(UITheme.TEXT_SECONDARY),
            toHex(UITheme.ACCENT_SUCCESS),
            cacheHitRate
        ));
    }
    
    private String toHex(Color color) {
        return String.format("#%02x%02x%02x", color.getRed(), color.getGreen(), color.getBlue());
    }

    public void refreshFindings() {
        List<MemoryManager.FindingRecord> recent = memoryManager.getRecentFindings();
        findingsModel.clear();
        for (int i = recent.size() - 1; i >= 0; i--) {
            findingsModel.addElement(recent.get(i));
        }
    }

    private JPanel createFindingsPanel() {
        JPanel findingsCard = StyledComponents.createCardPanel();
        findingsCard.setLayout(new BorderLayout());
        findingsCard.setBorder(BorderFactory.createCompoundBorder(
            findingsCard.getBorder(),
            BorderFactory.createEmptyBorder(UITheme.PADDING_MEDIUM, UITheme.PADDING_MEDIUM,
                                            UITheme.PADDING_MEDIUM, UITheme.PADDING_MEDIUM)
        ));

        JLabel title = StyledComponents.createSubheadingLabel("Recent Tentative Findings");
        title.setBorder(BorderFactory.createEmptyBorder(0, 0, UITheme.PADDING_MEDIUM, 0));
        findingsCard.add(title, BorderLayout.NORTH);

        JScrollPane scrollPane = StyledComponents.createStyledScrollPane(findingsList);
        scrollPane.setPreferredSize(new Dimension(0, 180));
        findingsCard.add(scrollPane, BorderLayout.CENTER);

        JLabel help = StyledComponents.createBodyLabel("Findings appear here because Burp Community does not expose the Scanner tab.");
        help.setForeground(UITheme.TEXT_MUTED);
        help.setBorder(BorderFactory.createEmptyBorder(UITheme.PADDING_SMALL, 0, 0, 0));
        findingsCard.add(help, BorderLayout.SOUTH);

        return findingsCard;
    }

    private class FindingsCellRenderer extends DefaultListCellRenderer {
        @Override
        public Component getListCellRendererComponent(JList<?> list, Object value, int index,
                                                      boolean isSelected, boolean cellHasFocus) {
            JLabel label = (JLabel) super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);
            if (value instanceof MemoryManager.FindingRecord) {
                MemoryManager.FindingRecord record = (MemoryManager.FindingRecord) value;
                String time = timeFormatter.format(Instant.ofEpochMilli(record.timestampMs));
                StringBuilder html = new StringBuilder();
                html.append("<html><div style='line-height:1.4;'>")
                    .append("<b style='color: ").append(toHex(UITheme.ACCENT_PRIMARY)).append(";'>")
                    .append(escapeHtml(record.title)).append("</b><br>")
                    .append("<span style='color: ").append(toHex(UITheme.TEXT_SECONDARY)).append(";'>")
                    .append(time).append("</span><br>")
                    .append("<span style='color: ").append(toHex(UITheme.TEXT_PRIMARY)).append(";'>")
                    .append(escapeHtml(record.preview)).append("</span>")
                    .append("</div></html>");
                label.setText(html.toString());
                label.setBorder(new EmptyBorder(UITheme.PADDING_SMALL, UITheme.PADDING_SMALL,
                        UITheme.PADDING_SMALL, UITheme.PADDING_SMALL));
                label.setOpaque(true);
                if (isSelected) {
                    label.setBackground(UITheme.ACCENT_SECONDARY.darker());
                    label.setForeground(UITheme.TEXT_PRIMARY);
                } else {
                    label.setBackground(new Color(0, 0, 0, 0));
                    label.setForeground(UITheme.TEXT_PRIMARY);
                }
            }
            return label;
        }
    }

    private String escapeHtml(String input) {
        if (input == null) {
            return "";
        }
        return input.replace("&", "&amp;")
                .replace("<", "&lt;")
                .replace(">", "&gt;");
    }
    
    @Override
    public String getTabCaption() {
        return "Memory";
    }
    
    @Override
    public Component getUiComponent() {
        return this;
    }
}
