package ai.pentest;

import burp.IBurpExtenderCallbacks;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * Logger for LLM responses that saves to a markdown file.
 * Preserves formatting and uses markdown syntax for better readability.
 */
public class LLMOutputLogger {
    private final IBurpExtenderCallbacks callbacks;
    private final SimpleDateFormat fmt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    private final ExecutorService executor = Executors.newSingleThreadExecutor(r -> {
        Thread t = new Thread(r, "ai-llm-output-logger");
        t.setDaemon(true);
        return t;
    });
    private final File outFile;
    private boolean fileInitialized = false;

    public LLMOutputLogger(IBurpExtenderCallbacks callbacks) {
        this.callbacks = callbacks;
        File dir = new File(System.getProperty("user.home"), ".burp-ai-audit");
        if (!dir.exists()) dir.mkdirs();
        this.outFile = new File(dir, "llm-output.md");
    }

    /**
     * Log a batch summary response with markdown formatting.
     */
    public void logBatchSummary(String vulnerabilityCategory, int endpointCount, String formattedResponse) {
        if (formattedResponse == null || formattedResponse.trim().isEmpty()) {
            return;
        }
        
        String timestamp = fmt.format(new Date());
        StringBuilder markdown = new StringBuilder();
        
        markdown.append("\n\n---\n\n");
        markdown.append("## ").append(timestamp).append(" - Batch Summary: ").append(vulnerabilityCategory);
        markdown.append(" (").append(endpointCount).append(" endpoint").append(endpointCount != 1 ? "s" : "").append(")\n\n");
        markdown.append(formattedResponse);
        markdown.append("\n\n");
        
        executor.submit(() -> appendToFile(markdown.toString()));
    }

    /**
     * Log a real-time response with markdown formatting.
     */
    public void logRealTimeResponse(String method, String path, String response) {
        if (response == null || response.trim().isEmpty()) {
            return;
        }
        
        String timestamp = fmt.format(new Date());
        StringBuilder markdown = new StringBuilder();
        
        markdown.append("\n\n---\n\n");
        markdown.append("### ").append(timestamp).append(" - Real-time: ").append(method).append(" ").append(path).append("\n\n");
        markdown.append("```\n");
        markdown.append(response);
        markdown.append("\n```\n\n");
        
        executor.submit(() -> appendToFile(markdown.toString()));
    }

    /**
     * Log an error message with markdown formatting.
     */
    public void logError(String context, String errorMessage) {
        if (errorMessage == null || errorMessage.trim().isEmpty()) {
            return;
        }
        
        String timestamp = fmt.format(new Date());
        StringBuilder markdown = new StringBuilder();
        
        markdown.append("\n\n---\n\n");
        markdown.append("### ").append(timestamp).append(" - Error: ").append(context).append("\n\n");
        markdown.append("**Error:** ").append(errorMessage).append("\n\n");
        
        executor.submit(() -> appendToFile(markdown.toString()));
    }

    /**
     * Initialize the markdown file with a header if it's a new file.
     */
    private void ensureFileInitialized() {
        if (fileInitialized) return;
        
        if (!outFile.exists() || outFile.length() == 0) {
            String header = "# AI Pentest Assistant - LLM Output Log\n\n" +
                    "This file contains all LLM responses from the AI Pentest Assistant extension.\n\n" +
                    "**Generated:** " + fmt.format(new Date()) + "\n\n" +
                    "---\n\n";
            
            try (BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(
                    new FileOutputStream(outFile, false), StandardCharsets.UTF_8))) {
                bw.write(header);
            } catch (IOException e) {
                callbacks.printError("LLMOutputLogger: Failed to initialize file - " + e.getMessage());
            }
        }
        fileInitialized = true;
    }

    /**
     * Append content to the markdown file using UTF-8 encoding.
     */
    private void appendToFile(String content) {
        ensureFileInitialized();
        
        try (BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(
                new FileOutputStream(outFile, true), StandardCharsets.UTF_8))) {
            bw.write(content);
            bw.flush();
        } catch (IOException e) {
            callbacks.printError("LLMOutputLogger: Failed to write to file - " + e.getMessage());
        }
    }

    /**
     * Flush any pending writes and close the logger.
     */
    public void shutdown() {
        executor.shutdown();
    }
}

