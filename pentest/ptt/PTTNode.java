package ai.pentest.ptt;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

/**
 * PTTNode represents a node in the Pentesting Task Tree.
 * Each node holds: hypothesis/title, category, heuristic tag, score [0..1], evidence snippets,
 * and child nodes (branches). Execution is passive-only by default.
 */
public class PTTNode {
    public enum State { PENDING, EVALUATED }
    public enum Status { TODO, ONGOING, SUCCESS, FAIL }

    private final String id;              // stable key per endpoint + branch
    private final String title;           // e.g., "API1/BOLA: ID Tampering"
    private final String category;        // OWASP API category label
    private final String heuristic;       // source heuristic name
    private final String parentId;        // parent reference (id) for traceability
    private final String taskDescription; // concise task description
    private final String expectedResult;  // expected signal/evidence
    private final List<String> evidence;  // compact evidence strings
    private final List<PTTNode> children;

    private volatile double score;        // 0..1 likelihood
    private volatile State state;
    private volatile Status status;       // operational status

    public PTTNode(String id, String title, String category, String heuristic) {
        this(id, title, category, heuristic, null, null, null);
    }

    public PTTNode(String id, String title, String category, String heuristic,
                   String parentId, String taskDescription, String expectedResult) {
        this.id = id;
        this.title = title;
        this.category = category;
        this.heuristic = heuristic;
        this.parentId = parentId;
        this.taskDescription = taskDescription == null ? "" : taskDescription;
        this.expectedResult = expectedResult == null ? "" : expectedResult;
        this.evidence = new ArrayList<>();
        this.children = new ArrayList<>();
        this.score = 0.0;
        this.state = State.PENDING;
        this.status = Status.TODO;
    }

    public String getId() { return id; }
    public String getTitle() { return title; }
    public String getCategory() { return category; }
    public String getHeuristic() { return heuristic; }
    public String getParentId() { return parentId; }
    public String getTaskDescription() { return taskDescription; }
    public String getExpectedResult() { return expectedResult; }
    public double getScore() { return score; }
    public void setScore(double score) { this.score = Math.max(0.0, Math.min(1.0, score)); }
    public State getState() { return state; }
    public void setState(State state) { this.state = state; }
    public Status getStatus() { return status; }
    public void setStatus(Status status) { this.status = status; }

    public List<String> getEvidence() { return Collections.unmodifiableList(evidence); }
    public void addEvidence(String snippet) { if (snippet != null && !snippet.isEmpty()) evidence.add(snippet); }

    public List<PTTNode> getChildren() { return Collections.unmodifiableList(children); }
    public void addChild(PTTNode child) { if (child != null) children.add(child); }
}


