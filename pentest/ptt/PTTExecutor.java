package ai.pentest.ptt;

import ai.pentest.RequestFingerprint;
import burp.*;

import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.ArrayDeque;
import java.util.ArrayList;
import java.util.Deque;
import java.util.List;

/**
 * Passive-only executor: builds a small tree per endpoint using scaffolds and scores nodes from observed traffic.
 * Designed to be cheap: bounded width/depth and no intrusive actions.
 */
public class PTTExecutor {
    private final IBurpExtenderCallbacks callbacks;
    private final IExtensionHelpers helpers;

    private final int maxNodes;

    public static class Result {
        public final List<PTTNode> evaluated;
        public Result(List<PTTNode> evaluated) { this.evaluated = evaluated; }
    }

    public PTTExecutor(IBurpExtenderCallbacks callbacks, int maxNodes) {
        this.callbacks = callbacks;
        this.helpers = callbacks.getHelpers();
        this.maxNodes = Math.max(8, maxNodes);
    }

    public List<PTTNode> seedTreeForEndpoint(IRequestInfo req) {
        URL url = req.getUrl();
        String path = url.getPath().toLowerCase();
        String method = req.getMethod();
        List<PTTNode> roots = new ArrayList<>();
        String baseId = url.getHost() + url.getPath().replaceAll("/v\\d+/?", "/");

        String query = url.getQuery();
        String pathWithQuery = path;
        if (query != null && !query.isEmpty()) {
            pathWithQuery = path + "?" + query.toLowerCase();
        }

        // Comprehensive BOLA seeding - Juice Shop and DVWA patterns
        boolean shouldCheckBOLA = 
            // Numeric IDs in path
            path.matches(".*/(?:user|profile|account|customer|member|client|employee)/\\d+.*") ||
            path.matches(".*/\\d+/.*") ||
            path.matches(".*/id/\\d+.*") ||
            // UUIDs in path (can be tampered)
            EvidencePatterns.UUID_IN_PATH.matcher(path).find() ||
            // Resource-oriented paths (Juice Shop: /rest/basket/{id}, /rest/products/{id})
            EvidencePatterns.RESOURCE_PATH.matcher(path).find() ||
            // User-oriented paths
            EvidencePatterns.USER_PATH.matcher(path).find() ||
            // Hierarchical resources
            EvidencePatterns.HIERARCHICAL_PATH.matcher(path).find() ||
            // Query parameter indicators
            (query != null && (query.matches(".*(?:user|account|customer|id|userId|accountId|orderId|basketId|productId|invoiceId)=\\d+.*") ||
                              query.matches(".*(?:user|account|id|uuid|guid)=[a-f0-9-]+.*"))) ||
            // Self endpoints that expose IDs
            path.matches(".*/(?:me|self|current).*") ||
            // DVWA user ID in query
            (query != null && query.matches(".*id=\\d+.*"));

        if (shouldCheckBOLA) {
            roots.addAll(CategoryScaffolds.buildBOLA(baseId));
        }

        // Comprehensive Broken Authentication seeding
        boolean shouldCheckBrokenAuth =
            // Authentication endpoints
            path.matches(".*/(?:login|signin|auth|authenticate|signup|register|logout|signout).*") ||
            path.matches(".*/(?:oauth|sso|saml|jwt|token|refresh|validate).*") ||
            // Protected resources (most API endpoints require auth)
            path.matches(".*/(?:api|rest)/.*") ||
            path.matches(".*/(?:user|account|profile|admin|dashboard|settings).*") ||
            // Request has auth indicators
            req.getHeaders().stream().anyMatch(h -> h.toLowerCase().startsWith("authorization:")) ||
            req.getHeaders().stream().anyMatch(h -> h.toLowerCase().startsWith("cookie:")) ||
            // Session management endpoints
            path.matches(".*/(?:session|sess|sid).*") ||
            (query != null && query.matches(".*(?:session|sess|sid|token|access_token)=.*")) ||
            // DVWA login
            path.contains("login.php") ||
            // Juice Shop authentication
            path.matches(".*/rest/(?:user|authentication)/.*");

        if (shouldCheckBrokenAuth) {
            roots.addAll(CategoryScaffolds.buildBrokenAuth(baseId));
        }

        // Security Misconfiguration - always check (affects all endpoints)
        roots.addAll(CategoryScaffolds.buildSecurityMisconfig(baseId));

        // Function Level Authorization
        if (path.contains("/admin") || path.contains("/internal") || 
            EvidencePatterns.ADMIN_PATH.matcher(path).find() ||
            path.contains("vulnerabilities.php") || path.contains("setup.php")) {
            roots.addAll(CategoryScaffolds.buildFunctionLevelAuth(baseId));
        }

        // SSRF
        if (pathWithQuery.contains("?url=") || pathWithQuery.contains("callback=") ||
            EvidencePatterns.URL_PARAM_NAME.matcher(pathWithQuery).find()) {
            roots.addAll(CategoryScaffolds.buildSSRF(baseId));
        }

        // Cap at 5 roots for performance (increased from 4 to include Security Misconfig)
        return roots.subList(0, Math.min(5, roots.size()));
    }

    public Result evaluatePassively(List<IHttpRequestResponse> samples, List<PTTNode> roots) {
        List<PTTNode> evaluated = new ArrayList<>();
        Deque<PTTNode> q = new ArrayDeque<>(roots);
        int budget = maxNodes;
        while (!q.isEmpty() && budget-- > 0) {
            PTTNode node = q.pollFirst();
            double score = scoreFromSamples(node, samples);
            node.setScore(score);
            node.setState(PTTNode.State.EVALUATED);
            if (score >= 0.8) node.setStatus(PTTNode.Status.SUCCESS);
            else if (score >= 0.5) node.setStatus(PTTNode.Status.ONGOING);
            else node.setStatus(PTTNode.Status.TODO);
            evaluated.add(node);
            if (score >= 0.6) {
                // expand promising branches only
                for (PTTNode c : node.getChildren()) q.addLast(c);
            }
        }
        return new Result(evaluated);
    }

    private double scoreFromSamples(PTTNode node, List<IHttpRequestResponse> samples) {
        double score = 0.0;
        if (samples == null || samples.isEmpty()) return 0.0;

        for (IHttpRequestResponse sample : samples) {
            byte[] respBytes = sample.getResponse();
            if (respBytes == null) continue;
            IRequestInfo qi = helpers.analyzeRequest(sample);
            IResponseInfo ri = helpers.analyzeResponse(respBytes);
            if (qi == null || ri == null) continue;

            byte[] respBodyBytes = getBody(respBytes, ri.getBodyOffset());
            String responseBody = new String(respBodyBytes, StandardCharsets.UTF_8);
            byte[] reqBodyBytes = RequestFingerprint.getRequestBody(helpers, sample);
            String requestBody = new String(reqBodyBytes, StandardCharsets.UTF_8);
            String path = qi.getUrl().getPath();
            List<String> reqHeaders = qi.getHeaders();
            List<String> respHeaders = ri.getHeaders();
            String headersStr = String.join("\n", respHeaders).toLowerCase();
            int statusCode = ri.getStatusCode();

            // ========== COMPREHENSIVE BOLA SCORING ==========
            if (node.getTitle().contains("BOLA")) {
                double bolaScore = 0.0;
                
                // 1. ID Predictability Patterns (DVWA/Juice Shop)
                if (path.matches(".*/\\d+(/.*)?")) {
                    bolaScore = Math.max(bolaScore, 0.4);
                    addEvidenceOnce(node, "numeric-id-in-path");
                    
                    // Short sequential IDs are more predictable (DVWA style)
                    if (path.matches(".*/\\d{1,6}(/.*)?$")) {
                        bolaScore = Math.max(bolaScore, 0.5);
                        addEvidenceOnce(node, "short-sequential-id-predictable");
                    }
                }
                
                // 2. UUID Presence (Juice Shop baskets, orders)
                if (EvidencePatterns.UUID_IN_BODY.matcher(responseBody).find()) {
                    bolaScore = Math.max(bolaScore, 0.6);
                    addEvidenceOnce(node, "uuid-in-response-body");
                }
                if (EvidencePatterns.UUID_IN_PATH.matcher(path).find()) {
                    bolaScore = Math.max(bolaScore, 0.5);
                    addEvidenceOnce(node, "uuid-in-path-tamperable");
                }
                
                // 3. Resource Paths (Juice Shop: /rest/basket/{id}, /rest/products/{id})
                if (EvidencePatterns.RESOURCE_PATH.matcher(path).find()) {
                    bolaScore = Math.max(bolaScore, 0.5);
                    addEvidenceOnce(node, "resource-path-with-id");
                    // Juice Shop basket/order IDs are common BOLA targets
                    if (path.matches(".*/(?:basket|order)/\\d+.*")) {
                        bolaScore = Math.max(bolaScore, 0.6);
                        addEvidenceOnce(node, "basket-or-order-id-exposed");
                    }
                }
                
                // 4. Authorization Header Analysis
                boolean hasAuth = reqHeaders.stream().anyMatch(h -> h.toLowerCase().startsWith("authorization:"));
                boolean hasBearer = reqHeaders.stream().anyMatch(h -> h.toLowerCase().startsWith("authorization: bearer"));
                boolean hasApiKey = reqHeaders.stream().anyMatch(h -> h.toLowerCase().matches(".*(?:api[_-]?key|apikey|x-api-key):.*"));
                boolean hasCookie = reqHeaders.stream().anyMatch(h -> h.toLowerCase().startsWith("cookie:"));
                
                if (!hasAuth && !hasCookie) {
                    bolaScore = Math.max(bolaScore, 0.4);
                    addEvidenceOnce(node, "no-authorization-header");
                    
                    // High risk if accessing user resources without auth
                    if (EvidencePatterns.USER_PATH.matcher(path).find() || 
                        EvidencePatterns.RESOURCE_PATH.matcher(path).find()) {
                        bolaScore = Math.max(bolaScore, 0.7);
                        addEvidenceOnce(node, "user-resource-accessed-without-auth");
                    }
                } else if (hasBearer) {
                    // Token present - check if it's validated (passive: check response consistency)
                    bolaScore = Math.max(bolaScore, 0.3);
                }
                
                // 5. Response Status Code Analysis
                if (statusCode == 200) {
                    if (EvidencePatterns.USER_PATH.matcher(path).find() || 
                        EvidencePatterns.RESOURCE_PATH.matcher(path).find()) {
                        if (!hasAuth) {
                            bolaScore = Math.max(bolaScore, 0.6);
                            addEvidenceOnce(node, "user-resource-200-without-auth-check");
                        }
                    }
                }
                if (statusCode == 403 && !hasAuth) {
                    bolaScore = Math.max(bolaScore, 0.4);
                    addEvidenceOnce(node, "403-without-auth-suggests-auth-check-exists");
                }
                if (statusCode == 401 && !hasAuth) {
                    bolaScore = Math.max(bolaScore, 0.5);
                    addEvidenceOnce(node, "401-indicates-auth-required");
                }
                
                // 6. Sensitive Data Exposure in Response (DVWA/Juice Shop)
                int sensitiveFieldCount = 0;
                if (responseBody.contains("\"email\"") || responseBody.toLowerCase().contains("\"e-mail\"")) {
                    sensitiveFieldCount++;
                }
                if (responseBody.contains("\"phone\"") || responseBody.contains("\"telephone\"")) {
                    sensitiveFieldCount++;
                }
                if (responseBody.contains("\"address\"")) {
                    sensitiveFieldCount++;
                }
                if (responseBody.contains("\"creditCard\"") || responseBody.contains("\"cardNumber\"") || 
                    responseBody.contains("\"card\"")) {
                    sensitiveFieldCount++;
                }
                if (responseBody.contains("\"ssn\"") || responseBody.contains("\"socialSecurityNumber\"")) {
                    sensitiveFieldCount++;
                }
                
                if (sensitiveFieldCount > 0) {
                    bolaScore = Math.max(bolaScore, 0.5);
                    addEvidenceOnce(node, "sensitive-data-in-response");
                    if (sensitiveFieldCount >= 3) {
                        bolaScore = Math.max(bolaScore, 0.7);
                        addEvidenceOnce(node, "multiple-sensitive-fields-exposed");
                    }
                }
                
                // 7. Role-Based Indicators (Juice Shop: admin role exposure)
                if (responseBody.matches("(?i).*\"role\"\\s*:\\s*\"(?:admin|manager|superuser|administrator)\".*")) {
                    bolaScore = Math.max(bolaScore, 0.6);
                    addEvidenceOnce(node, "admin-role-in-response-potential-escalation");
                }
                
                // 8. Self vs Others Endpoint Pattern
                if (path.matches(".*/(?:me|self|current|whoami).*") && responseBody.contains("\"id\"")) {
                    bolaScore = Math.max(bolaScore, 0.5);
                    addEvidenceOnce(node, "self-endpoint-exposes-user-id");
                }
                
                // 9. Query Parameter ID Tampering (DVWA: ?id=1)
                String query = qi.getUrl().getQuery();
                if (query != null) {
                    if (query.matches(".*[?&]id=\\d+.*")) {
                        bolaScore = Math.max(bolaScore, 0.5);
                        addEvidenceOnce(node, "id-in-query-parameter-tamperable");
                    }
                    // Check for ID mismatch between path and query
                    java.util.regex.Pattern pathIdPattern = java.util.regex.Pattern.compile("/(\\d+)(?:/|$)");
                    java.util.regex.Pattern queryIdPattern = java.util.regex.Pattern.compile("[?&]userId=(\\d+)");
                    java.util.regex.Matcher pathMatch = pathIdPattern.matcher(path);
                    java.util.regex.Matcher queryMatch = queryIdPattern.matcher(query);
                    if (pathMatch.find() && queryMatch.find()) {
                        if (!pathMatch.group(1).equals(queryMatch.group(1))) {
                            bolaScore = Math.max(bolaScore, 0.6);
                            addEvidenceOnce(node, "id-mismatch-between-path-and-query");
                        }
                    }
                }
                
                score = Math.max(score, bolaScore);
            }

            // ========== COMPREHENSIVE SECURITY MISCONFIGURATION SCORING ==========
            if (node.getTitle().contains("Security Misconfiguration")) {
                double misconfigScore = 0.0;
                int missingHeaders = 0;
                
                // 1. Missing Security Headers
                boolean hasCsp = headersStr.contains("content-security-policy:");
                boolean hasXcto = headersStr.contains("x-content-type-options:");
                boolean hasXfo = headersStr.contains("x-frame-options:");
                boolean hasHsts = headersStr.contains("strict-transport-security:");
                boolean hasRp = headersStr.contains("referrer-policy:");
                
                if (!hasCsp) {
                    missingHeaders++;
                    addEvidenceOnce(node, "missing-content-security-policy");
                }
                if (!hasXcto) {
                    missingHeaders++;
                    addEvidenceOnce(node, "missing-x-content-type-options");
                }
                if (!hasXfo) {
                    missingHeaders++;
                    addEvidenceOnce(node, "missing-x-frame-options");
                }
                if (!hasHsts && qi.getUrl().getProtocol().equals("https")) {
                    missingHeaders++;
                    addEvidenceOnce(node, "missing-hsts-on-https");
                }
                if (!hasRp) {
                    missingHeaders++;
                    addEvidenceOnce(node, "missing-referrer-policy");
                }
                
                if (missingHeaders >= 2) {
                    misconfigScore = Math.max(misconfigScore, 0.5);
                    if (missingHeaders >= 4) {
                        misconfigScore = Math.max(misconfigScore, 0.7);
                    }
                }
                
                // 2. Information Disclosure Headers (DVWA/Juice Shop)
                if (headersStr.contains("x-powered-by:")) {
                    misconfigScore = Math.max(misconfigScore, 0.4);
                    addEvidenceOnce(node, "x-powered-by-header-leaks-framework");
                }
                if (headersStr.contains("server:")) {
                    String serverHeader = respHeaders.stream()
                        .filter(h -> h.toLowerCase().startsWith("server:"))
                        .findFirst().orElse("");
                    if (serverHeader.matches("(?i).*apache/\\d\\.\\d.*") || 
                        serverHeader.matches("(?i).*nginx/\\d\\.\\d.*") ||
                        serverHeader.matches("(?i).*iis/\\d+.*")) {
                        misconfigScore = Math.max(misconfigScore, 0.5);
                        addEvidenceOnce(node, "server-header-exposes-version");
                    }
                }
                
                // 3. CORS Misconfiguration (Juice Shop often has CORS issues)
                if (headersStr.contains("access-control-allow-origin:")) {
                    String corsHeader = respHeaders.stream()
                        .filter(h -> h.toLowerCase().startsWith("access-control-allow-origin:"))
                        .findFirst().orElse("");
                    if (corsHeader.contains("*")) {
                        misconfigScore = Math.max(misconfigScore, 0.7);
                        addEvidenceOnce(node, "cors-allows-all-origins-wildcard");
                    }
                    if (corsHeader.contains("null")) {
                        misconfigScore = Math.max(misconfigScore, 0.6);
                        addEvidenceOnce(node, "cors-allows-null-origin");
                    }
                }
                
                if (headersStr.contains("access-control-allow-credentials: true") &&
                    headersStr.contains("access-control-allow-origin: *")) {
                    misconfigScore = Math.max(misconfigScore, 0.8);
                    addEvidenceOnce(node, "cors-credentials-with-wildcard-critical");
                }
                
                // 4. Cache Control Misconfiguration
                boolean hasCacheControl = headersStr.contains("cache-control:");
                if (path.matches(".*/(?:api|rest|v\\d+).*")) {
                    if (!hasCacheControl || headersStr.contains("cache-control: public")) {
                        if (responseBody.contains("\"token\"") || responseBody.contains("\"password\"") || 
                            responseBody.contains("\"apiKey\"")) {
                            misconfigScore = Math.max(misconfigScore, 0.7);
                            addEvidenceOnce(node, "sensitive-api-data-cacheable");
                        } else {
                            misconfigScore = Math.max(misconfigScore, 0.4);
                            addEvidenceOnce(node, "api-endpoint-missing-cache-control");
                        }
                    }
                }
                
                // 5. HTTP Method Exposure
                if (headersStr.contains("allow:") || headersStr.contains("access-control-allow-methods:")) {
                    String methods = respHeaders.stream()
                        .filter(h -> h.toLowerCase().matches(".*(?:allow|access-control-allow-methods):.*"))
                        .findFirst().orElse("");
                    if (methods.toLowerCase().contains("delete") || methods.toLowerCase().contains("put") ||
                        methods.toLowerCase().contains("patch")) {
                        misconfigScore = Math.max(misconfigScore, 0.4);
                        addEvidenceOnce(node, "dangerous-methods-exposed-delete-put-patch");
                    }
                }
                
                // 6. Error Message Information Disclosure (DVWA)
                if (statusCode >= 400) {
                    if (EvidencePatterns.STACK_TRACE.matcher(responseBody).find()) {
                        misconfigScore = Math.max(misconfigScore, 0.6);
                        addEvidenceOnce(node, "stack-trace-in-error-response");
                    }
                    if (responseBody.matches("(?i).*(?:file not found|directory listing|index of|403 forbidden).*")) {
                        misconfigScore = Math.max(misconfigScore, 0.5);
                        addEvidenceOnce(node, "directory-listing-or-error-disclosure");
                    }
                }
                
                // 7. Debug/Development Mode Indicators
                if (EvidencePatterns.DEBUG_HEADER.matcher(headersStr).find()) {
                    misconfigScore = Math.max(misconfigScore, 0.7);
                    addEvidenceOnce(node, "debug-headers-present-development-mode");
                }
                if (responseBody.contains("\"debug\"") || responseBody.contains("\"development\"") ||
                    responseBody.contains("debug mode") || responseBody.contains("development mode")) {
                    misconfigScore = Math.max(misconfigScore, 0.6);
                    addEvidenceOnce(node, "debug-mode-indicator-in-response");
                }
                
                // 8. HTTPS Enforcement
                if (qi.getUrl().getProtocol().equals("http") && 
                    (path.contains("/api/") || path.contains("/rest/") || 
                     path.contains("/login") || path.contains("/auth"))) {
                    misconfigScore = Math.max(misconfigScore, 0.7);
                    addEvidenceOnce(node, "api-or-auth-over-http-insecure");
                }
                
                // 9. Content-Type Issues
                if (statusCode == 200 && !headersStr.contains("content-type:")) {
                    misconfigScore = Math.max(misconfigScore, 0.3);
                    addEvidenceOnce(node, "missing-content-type-header");
                }
                if (headersStr.contains("content-type: text/html") && path.matches(".*\\.json.*")) {
                    misconfigScore = Math.max(misconfigScore, 0.4);
                    addEvidenceOnce(node, "content-type-mismatch-json-served-as-html");
                }
                
                score = Math.max(score, misconfigScore);
            }

            // ========== COMPREHENSIVE BROKEN AUTHENTICATION SCORING ==========
            if (node.getTitle().contains("Broken Authentication")) {
                double authScore = 0.0;
                String query = qi.getUrl().getQuery() != null ? qi.getUrl().getQuery().toLowerCase() : "";
                String pathLower = path.toLowerCase();
                
                // 1. Credentials in Query Parameters (DVWA/Juice Shop)
                if (query.contains("password=") || query.contains("passwd=") || query.contains("pwd=")) {
                    authScore = Math.max(authScore, 0.8);
                    addEvidenceOnce(node, "password-in-query-parameter-critical");
                }
                if (query.contains("api_key=") || query.contains("apikey=") || query.contains("api-key=")) {
                    authScore = Math.max(authScore, 0.6);
                    addEvidenceOnce(node, "api-key-in-query-parameter");
                }
                if (query.contains("token=") || query.contains("access_token=") || 
                    query.contains("bearer=") || query.contains("auth_token=")) {
                    authScore = Math.max(authScore, 0.7);
                    addEvidenceOnce(node, "token-in-query-parameter");
                }
                
                // 2. Weak Authentication Mechanisms
                if (query.matches(".*(?:username|user|email)=.*&(?:password|pass|pwd)=.*")) {
                    authScore = Math.max(authScore, 0.7);
                    addEvidenceOnce(node, "credentials-in-url-query");
                }
                
                // 3. Missing Authentication on Protected Resources
                boolean hasAuth = reqHeaders.stream().anyMatch(h -> h.toLowerCase().startsWith("authorization:"));
                boolean hasBearer = reqHeaders.stream().anyMatch(h -> h.toLowerCase().startsWith("authorization: bearer"));
                boolean hasBasic = reqHeaders.stream().anyMatch(h -> h.toLowerCase().startsWith("authorization: basic"));
                boolean hasCookie = reqHeaders.stream().anyMatch(h -> h.toLowerCase().startsWith("cookie:"));
                boolean hasApiKeyHeader = reqHeaders.stream().anyMatch(h -> h.toLowerCase().matches(".*(?:api[_-]?key|apikey|x-api-key):.*"));
                
                if (pathLower.matches(".*/(?:user|account|profile|admin|dashboard|settings|api|rest).*")) {
                    if (!hasAuth && !hasCookie && !hasApiKeyHeader) {
                        if (statusCode == 200) {
                            authScore = Math.max(authScore, 0.6);
                            addEvidenceOnce(node, "protected-resource-accessible-without-auth");
                        }
                    }
                }
                
                // 4. Session Management Issues (DVWA/Juice Shop)
                if (hasCookie) {
                    String cookieHeader = reqHeaders.stream()
                        .filter(h -> h.toLowerCase().startsWith("cookie:"))
                        .findFirst().orElse("");
                    String cookieLower = cookieHeader.toLowerCase();
                    
                    // Check for HttpOnly flag
                    if (!cookieLower.contains("httponly") && 
                        (cookieLower.contains("session") || cookieLower.contains("sess") || 
                         cookieLower.contains("sid") || cookieLower.contains("token"))) {
                        authScore = Math.max(authScore, 0.5);
                        addEvidenceOnce(node, "session-cookie-missing-httponly-flag");
                    }
                    
                    // Check for Secure flag (should be present on HTTPS)
                    if (qi.getUrl().getProtocol().equals("https") && 
                        !cookieLower.contains("secure") &&
                        (cookieLower.contains("session") || cookieLower.contains("sess") || 
                         cookieLower.contains("sid") || cookieLower.contains("token"))) {
                        authScore = Math.max(authScore, 0.6);
                        addEvidenceOnce(node, "session-cookie-missing-secure-flag-on-https");
                    }
                    
                    // Check for SameSite attribute
                    if (!cookieLower.contains("samesite") &&
                        (cookieLower.contains("session") || cookieLower.contains("sess") || 
                         cookieLower.contains("sid") || cookieLower.contains("token"))) {
                        authScore = Math.max(authScore, 0.4);
                        addEvidenceOnce(node, "session-cookie-missing-samesite-attribute");
                    }
                    
                    // Predictable session IDs (DVWA)
                    java.util.regex.Matcher sessMatch = EvidencePatterns.SESSION_ID.matcher(cookieHeader);
                    if (sessMatch.find()) {
                        String sessId = sessMatch.group(1);
                        if (sessId.length() < 16) {
                            authScore = Math.max(authScore, 0.5);
                            addEvidenceOnce(node, "short-session-id-predictable");
                        }
                        if (sessId.matches("^[0-9]+$")) {
                            authScore = Math.max(authScore, 0.6);
                            addEvidenceOnce(node, "numeric-session-id-very-predictable");
                        }
                        // PHP session IDs are often 32 hex chars
                        if (sessId.matches("^[a-f0-9]{32}$") && path.contains(".php")) {
                            authScore = Math.max(authScore, 0.4);
                            addEvidenceOnce(node, "php-session-id-standard-format");
                        }
                    }
                }
                
                // 5. JWT Token Issues (Juice Shop)
                if (hasBearer) {
                    String authHeader = reqHeaders.stream()
                        .filter(h -> h.toLowerCase().startsWith("authorization: bearer"))
                        .findFirst().orElse("");
                    if (authHeader.contains("Bearer ")) {
                        String token = authHeader.substring(authHeader.indexOf("Bearer ") + 7).trim();
                        // Check if JWT (has 3 parts separated by dots)
                        String[] parts = token.split("\\.");
                        if (parts.length == 3) {
                            authScore = Math.max(authScore, 0.4);
                            addEvidenceOnce(node, "jwt-token-detected");
                            
                            // Check token length (very short tokens are suspicious)
                            if (token.length() < 50) {
                                authScore = Math.max(authScore, 0.5);
                                addEvidenceOnce(node, "short-jwt-token-suspicious");
                            }
                        }
                    }
                }
                
                // 6. Basic Authentication Issues
                if (hasBasic) {
                    authScore = Math.max(authScore, 0.5);
                    addEvidenceOnce(node, "basic-authentication-used");
                    
                    // Check if used over HTTP
                    if (qi.getUrl().getProtocol().equals("http")) {
                        authScore = Math.max(authScore, 0.7);
                        addEvidenceOnce(node, "basic-auth-over-http-critical");
                    }
                }
                
                // 7. Response Analysis - Authentication Failures (DVWA)
                if (pathLower.matches(".*/(?:login|auth|signin).*")) {
                    if (statusCode == 200) {
                        if (responseBody.matches("(?i).*(?:invalid|incorrect|wrong|failed|error).*")) {
                            authScore = Math.max(authScore, 0.4);
                            addEvidenceOnce(node, "auth-failure-message-disclosure");
                        }
                    }
                    if (statusCode == 401) {
                        if (responseBody.contains("\"message\"") || responseBody.contains("message:")) {
                            if (responseBody.contains("user") && responseBody.contains("not found")) {
                                authScore = Math.max(authScore, 0.5);
                                addEvidenceOnce(node, "username-enumeration-via-error-message");
                            }
                        }
                    }
                }
                
                // 8. Token Exposure in Response (Juice Shop)
                if (EvidencePatterns.SENSITIVE_FIELD.matcher(responseBody).find()) {
                    if (responseBody.contains("\"token\"") || responseBody.contains("\"accessToken\"") ||
                        responseBody.contains("\"refreshToken\"") || responseBody.contains("\"apiKey\"")) {
                        authScore = Math.max(authScore, 0.7);
                        addEvidenceOnce(node, "token-or-api-key-exposed-in-response");
                    }
                }
                
                // 9. Multiple Authentication Methods (may indicate confusion)
                int authMethodCount = 0;
                if (hasAuth) authMethodCount++;
                if (hasCookie) authMethodCount++;
                if (hasApiKeyHeader) authMethodCount++;
                if (authMethodCount >= 2) {
                    authScore = Math.max(authScore, 0.3);
                    addEvidenceOnce(node, "multiple-auth-methods-may-indicate-confusion");
                }
                
                // 10. API Key in Headers (better than query, but check format)
                if (hasApiKeyHeader) {
                    String apiKeyHeader = reqHeaders.stream()
                        .filter(h -> h.toLowerCase().matches(".*(?:api[_-]?key|apikey|x-api-key):.*"))
                        .findFirst().orElse("");
                    // UUID format API keys are common
                    if (apiKeyHeader.matches(".*:.*[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}.*")) {
                        authScore = Math.max(authScore, 0.3);
                        addEvidenceOnce(node, "uuid-format-api-key-in-header");
                    }
                }
                
                score = Math.max(score, authScore);
            }

            // ========== OTHER CATEGORIES (keep existing logic) ==========
            if (node.getTitle().contains("SSRF")) {
                String combined = (qi.getUrl().getQuery() != null ? qi.getUrl().getQuery() : "") + "&" + requestBody;
                if (EvidencePatterns.URL_PARAM_NAME.matcher(combined).find()) {
                    score = Math.max(score, 0.6);
                    addEvidenceOnce(node, "url-param-input-ssrf-indicator");
                }
            }

            if (node.getTitle().contains("Excessive Data Exposure")) {
                if (EvidencePatterns.VERBOSE_JSON.matcher(responseBody).find()) {
                    score = Math.max(score, 0.6);
                    addEvidenceOnce(node, "verbose-json-sensitive-fields");
                }
            }

            if (node.getTitle().contains("Property Level Authorization")) {
                if (EvidencePatterns.VERBOSE_JSON.matcher(responseBody).find()) {
                    score = Math.max(score, 0.55);
                    addEvidenceOnce(node, "sensitive-fields-exposed");
                }
            }

            if (node.getTitle().contains("Function Level Authorization")) {
                if (EvidencePatterns.ADMIN_PATH.matcher(path).find() && statusCode == 200) {
                    score = Math.max(score, 0.6);
                    addEvidenceOnce(node, "admin-path-accessible-200");
                }
            }

            if (node.getTitle().contains("Sensitive Business Flows")) {
                if (qi.getMethod().equalsIgnoreCase("POST") && path.matches("(?i).*(/order|/payment|/transfer|/checkout).*$")) {
                    score = Math.max(score, 0.5);
                    addEvidenceOnce(node, "business-flow-endpoint-detected");
                }
            }

            if (node.getTitle().contains("Improper Inventory Management")) {
                if (EvidencePatterns.VERSION_PATH.matcher(path).find()) {
                    score = Math.max(score, 0.5);
                    addEvidenceOnce(node, "versioned-api-path");
                }
            }

            if (node.getTitle().contains("Unsafe Consumption of APIs")) {
                if (EvidencePatterns.URL_PARAM_NAME.matcher(requestBody).find()) {
                    score = Math.max(score, 0.45);
                    addEvidenceOnce(node, "external-url-input-in-request-body");
                }
            }

            // Global SQL error boost (DVWA)
            if (EvidencePatterns.SQL_ERROR.matcher(responseBody).find()) {
                score = Math.min(score + 0.2, 0.8);
                addEvidenceOnce(node, "SQL-error-in-response");
            }
        }

        // Normalize by sample count but use max scoring (not average)
        return Math.min(1.0, score);
    }

    private byte[] getBody(byte[] full, int offset) {
        if (full == null || full.length <= offset) return new byte[0];
        byte[] body = new byte[full.length - offset];
        System.arraycopy(full, offset, body, 0, body.length);
        return body;
    }

    private void addEvidenceOnce(PTTNode node, String evidence) {
        if (evidence == null || evidence.isEmpty()) return;
        if (!node.getEvidence().contains(evidence)) {
            node.addEvidence(evidence);
        }
    }
}


