package ai.pentest.ptt;

import burp.IRequestInfo;

import java.net.URL;
import java.util.ArrayList;
import java.util.List;

/**
 * Builds the full PTT tree: Root -> Phases -> Category scaffolds/leaves.
 * Passive by default; exploitation/reporting are placeholders requiring manual approval.
 */
public class PTTRootBuilder {

    public static class RootWithChildren {
        public final PTTNode root;
        public final List<PTTNode> phaseRoots;
        public RootWithChildren(PTTNode root, List<PTTNode> phaseRoots) {
            this.root = root;
            this.phaseRoots = phaseRoots;
        }
    }

    public RootWithChildren build(IRequestInfo req) {
        URL url = req.getUrl();
        String base = url.getHost() + url.getPath();

        PTTNode root = new PTTNode(
                base+"/root",
                "Automated API Penetration Testing â€“ OWASP Top 10 2023",
                "root",
                "framework",
                null,
                "High-level objective node",
                "End-to-end API assessment plan"
        );

        PTTNode recon = new PTTNode(base+"/phase-recon", "Phase: Reconnaissance", "phase", "recon", root.getId(),
                "Map endpoints, parameters, headers from passive traffic", "Endpoint inventory, param list, header clues");
        PTTNode vuln = new PTTNode(base+"/phase-vuln", "Phase: Vulnerability Testing", "phase", "vuln", root.getId(),
                "OWASP API Top 10 category checks", "Scored category hypotheses");
        PTTNode exploit = new PTTNode(base+"/phase-exploit", "Phase: Exploitation & Confirmation", "phase", "exploit", root.getId(),
                "Manual confirm promising leaves (requires approval)", "Reproduced evidence");
        PTTNode report = new PTTNode(base+"/phase-report", "Phase: Reporting", "phase", "report", root.getId(),
                "Synthesize findings and evidence", "Concise report entries");

        // Recon leaves (passive)
        PTTNode mapEndpoints = new PTTNode(base+"/recon-map", "Recon: Endpoint Mapping", "recon", "urls", recon.getId(),
                "Identify unique API paths from proxy history", "List of /api/... endpoints");
        PTTNode enumParams = new PTTNode(base+"/recon-params", "Recon: Parameter Enumeration", "recon", "params", recon.getId(),
                "Enumerate query/JSON keys from captured requests", "Param inventory (e.g., userId, token) ");
        PTTNode headerClues = new PTTNode(base+"/recon-headers", "Recon: Header Clues", "recon", "headers", recon.getId(),
                "Analyze headers for auth schemes, CORS, cache hints", "Auth/CORS/misc hardening notes");
        recon.addChild(mapEndpoints);
        recon.addChild(enumParams);
        recon.addChild(headerClues);

        // Vulnerability Testing: attach all category scaffolds
        List<PTTNode> cats = new ArrayList<>();
        cats.addAll(CategoryScaffolds.buildBOLA(base));
        cats.addAll(CategoryScaffolds.buildBrokenAuth(base));
        cats.addAll(CategoryScaffolds.buildPropertyLevelAuth(base));
        cats.addAll(CategoryScaffolds.buildExcessiveData(base));
        cats.addAll(CategoryScaffolds.buildFunctionLevelAuth(base));
        cats.addAll(CategoryScaffolds.buildBusinessFlows(base));
        cats.addAll(CategoryScaffolds.buildSSRF(base));
        cats.addAll(CategoryScaffolds.buildSecurityMisconfig(base));
        cats.addAll(CategoryScaffolds.buildInventory(base));
        cats.addAll(CategoryScaffolds.buildUnsafeConsumption(base));
        for (PTTNode c : cats) vuln.addChild(c);

        // Exploitation & Reporting placeholders
        PTTNode confirm = new PTTNode(base+"/exploit-confirm", "Confirm High-Score Leaves (>0.8)", "exploit", "manual", exploit.getId(),
                "Use Repeater/Intruder with consent to verify", "Repro steps and raw evidence");
        PTTNode synth = new PTTNode(base+"/report-summarize", "Summarize & Export", "report", "export", report.getId(),
                "Summarize findings and export", "Concise findings list");
        exploit.addChild(confirm);
        report.addChild(synth);

        root.addChild(recon);
        root.addChild(vuln);
        root.addChild(exploit);
        root.addChild(report);

        List<PTTNode> phases = new ArrayList<>();
        phases.add(recon);
        phases.add(vuln);
        phases.add(exploit);
        phases.add(report);
        return new RootWithChildren(root, phases);
    }
}


