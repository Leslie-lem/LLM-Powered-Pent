package ai.pentest.ptt;

import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

/**
 * Simple in-memory cache for PTT evaluations per endpoint key.
 * Stores a compact JSON-like snapshot: [{id, title, score, status}].
 */
public class PTTCache {

    private final Map<String, String> cache = Collections.synchronizedMap(new LinkedHashMap<String, String>(64, 0.75f, true) {
        @Override
        protected boolean removeEldestEntry(Map.Entry<String, String> eldest) {
            return size() > 256;
        }
    });

    public void putSnapshot(String endpointKey, List<PTTNode> evaluated) {
        if (endpointKey == null || evaluated == null) return;
        cache.put(endpointKey, toJson(evaluated));
    }

    public String getSnapshot(String endpointKey) {
        return cache.get(endpointKey);
    }
    
    public void clear() {
        cache.clear();
    }
    
    public int size() {
        return cache.size();
    }

    public java.util.List<PTTNode> loadSnapshot(String json) {
        if (json == null || !json.startsWith("[")) return java.util.Collections.emptyList();

        java.util.List<PTTNode> stubs = new java.util.ArrayList<>();
        String[] nodes = json.split("\\},\\s*\\{");
        for (String raw : nodes) {
            String n = raw;
            if (!n.contains("\"title\"")) continue;

            int titleStart = n.indexOf("\"title\":\"");
            if (titleStart < 0) continue;
            titleStart += 9;
            int titleEnd = n.indexOf("\"", titleStart);
            if (titleEnd < 0) continue;
            String title = n.substring(titleStart, titleEnd).replace("\\\"", "\"");

            int scoreStart = n.indexOf("\"score\":");
            if (scoreStart < 0) continue;
            scoreStart += 8;
            int scoreEnd = n.indexOf(',', scoreStart);
            if (scoreEnd < 0) {
                scoreEnd = n.indexOf('}', scoreStart);
                if (scoreEnd < 0) scoreEnd = n.length();
            }
            String scoreStr = n.substring(scoreStart, scoreEnd).trim();
            double score = 0.0;
            try {
                score = Double.parseDouble(scoreStr);
            } catch (NumberFormatException ignored) {
            }

            PTTNode stub = new PTTNode("cached-" + title.hashCode(), title, "cached", "prior");
            stub.setScore(score);
            stubs.add(stub);
        }

        return stubs;
    }

    private String toJson(List<PTTNode> evaluated) {
        StringBuilder sb = new StringBuilder();
        sb.append("[");
        boolean first = true;
        for (PTTNode n : evaluated) {
            if (!first) sb.append(",");
            first = false;
            sb.append("{")
              .append("\"id\":\"").append(escape(n.getId())).append("\",")
              .append("\"title\":\"").append(escape(n.getTitle())).append("\",")
              .append("\"score\":").append(String.format(java.util.Locale.ROOT, "%.2f", n.getScore())).append(",")
              .append("\"status\":\"").append(n.getStatus() == null ? "" : n.getStatus().name()).append("\"")
              .append("}");
        }
        sb.append("]");
        return sb.toString();
    }

    private String escape(String s) {
        if (s == null) return "";
        return s.replace("\\", "\\\\").replace("\"", "\\\"").replace("\n", "\\n");
    }
}


